# Smokeping Apache Virtual Host
#
# Generated by Chef
<VirtualHost *:<%= node['smokeping']['port'] %>>
  <% if node['smokeping']['admin_email'] %>ServerAdmin     <%= node['smokeping']['admin_email'] %><% end %>
  ServerName      <%= node['smokeping']['server_name'] %>
  <% if node['smokeping']['server_alias'] %>ServerAlias     <%= node['smokeping']['server_alias'] %><% end %>

  DocumentRoot <%= node['smokeping']['webroot'] %>

  RewriteEngine on
  RewriteCond %{REQUEST_URI} !^/smokeping/.+
  RewriteCond %{REQUEST_URI} !^/smokeping\.cgi
  RewriteRule ^(.*)$ /smokeping.cgi [R=301]

  Alias /smokeping/images <%= node['smokeping']['imgcache'] %>
  Alias /smokeping <%= node['smokeping']['webroot'] %>

  <Directory "<%= node['smokeping']['imgcache'] %>">
      Options FollowSymLinks
      <%if node['apache']['version'].to_f >= 2.4 %>
      Require all granted
      <% else %>
      Order allow,deny
      Allow from all
      <% end %>
  </Directory>

  <Directory "<%= node['smokeping']['webroot'] %>">
      Options FollowSymLinks
  </Directory>

  <Location />
    AuthName "Smokeping Server"
  </Location>

  ScriptAlias /smokeping.cgi <%= node['smokeping']['cgi'] %>
  <Directory "<%= File.dirname(node['smokeping']['cgi']) %>">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    <%if node['apache']['version'].to_f >= 2.4 %>
    Require all granted
    <% else %>
    Order allow,deny
    Allow from all
    <% end %>
  </Directory>

</VirtualHost>

